# Z-IMAGE GOLDEN PATH - –ü–ª–∞–Ω —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏

## üéØ –¶–µ–ª—å
–°–¥–µ–ª–∞—Ç—å z-image –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∞–∫—Ç–∏–≤–Ω—ã–º UX-–ø–æ—Ç–æ–∫–æ–º –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 100% —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (20/20 —É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≥–æ–Ω–æ–≤).

## ‚úÖ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ z-image

### –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è (source of truth)
```yaml
z-image:
  model_type: text_to_image
  input:
    prompt:
      type: string
      required: true
      max: 1000
    aspect_ratio:
      type: enum
      required: true
      values: [1:1, 4:3, 3:4, 16:9, 9:16]
```

### API –∫–æ–Ω—Ç—Ä–∞–∫—Ç
```http
POST https://api.kie.cn/createTask
Authorization: Bearer {KIE_API_KEY}
Content-Type: application/json

{
  "model": "z-image",
  "callBackUrl": "https://five656.onrender.com/callbacks/kie",
  "input": {
    "prompt": "—Ç–µ–∫—Å—Ç –¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤",
    "aspect_ratio": "1:1"  // –∏–ª–∏ 4:3, 3:4, 16:9, 9:16
  }
}

Response:
{
  "code": 200,
  "data": {
    "taskId": "uuid-string"
  }
}

Callback:
POST /callbacks/kie
{
  "taskId": "uuid-string",
  "recordInfo": {
    "status": "FINISHED",
    "resultUrls": ["https://..."]
  }
}
```

## üìã TODO List (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

### –§–ê–ó–ê 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ lock/webhook (–°–ï–ô–ß–ê–°)
- [x] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏ –≤ lock acquisition
- [ ] –î–æ–∂–¥–∞—Ç—å—Å—è –¥–µ–ø–ª–æ—è —Å –ª–æ–≥–∞–º–∏ (~2 –º–∏–Ω)
- [ ] –ï—Å–ª–∏ lock –∑–∞–Ω—è—Ç ‚Üí restart Render service
- [ ] –ï—Å–ª–∏ lock —Å–≤–æ–±–æ–¥–µ–Ω ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å /start —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü–æ—Å–ª–µ /start ‚Üí —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å z-image –≥–µ–Ω–µ—Ä–∞—Ü–∏—é

### –§–ê–ó–ê 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ z-image —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- [ ] –ù–∞–π—Ç–∏ —Ç–µ–∫—É—â–∏–π –∫–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ z-image
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å payload —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ (prompt + aspect_ratio)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å callback –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å 5 —Ç–µ—Å—Ç–æ–≤—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π z-image
- [ ] –ï—Å–ª–∏ 5/5 —É—Å–ø–µ—à–Ω–æ ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –§–ê–ó–ï 3

### –§–ê–ó–ê 3: –°–¥–µ–ª–∞—Ç—å z-image –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –≤ UI
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏—á–∞-—Ñ–ª–∞–≥ ENABLE_Z_IMAGE_ONLY=true
- [ ] –í start menu –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¢–û–õ–¨–ö–û z-image –∫–Ω–æ–ø–∫—É
- [ ] –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ —Å–∫—Ä—ã—Ç—å (–ù–ï —É–¥–∞–ª—è—Ç—å –∫–æ–¥!)
- [ ] Aspect ratio selector: 5 –∫–Ω–æ–ø–æ–∫ (1:1, 4:3, 3:4, 16:9, 9:16)
- [ ] Prompt input —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π <=1000 —Å–∏–º–≤–æ–ª–æ–≤

### –§–ê–ó–ê 4: Persistence –∫ —ç—Ç–∞–ª–æ–Ω—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ (IF EXISTS/IF NOT EXISTS)
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è ensure_user –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –í–ï–ó–î–ï
- [ ] –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å job –î–û API –≤—ã–∑–æ–≤–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å orphan_callbacks —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å 10 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å 0 –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö

### –§–ê–ó–ê 5: –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç
- [ ] 20 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π z-image –ø–æ–¥—Ä—è–¥
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ callback –ø–æ–ª—É—á–µ–Ω—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å 0 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å–ø–∏—Å–∞–Ω–∏–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å 0 –æ—à–∏–±–æ–∫ "Schema NOT ready"
- [ ] –ï—Å–ª–∏ 20/20 —É—Å–ø–µ—à–Ω–æ ‚Üí z-image –°–¢–ê–ë–ò–õ–ï–ù ‚úÖ

### –§–ê–ó–ê 6: –®–∞–±–ª–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥–µ–ª–µ–π
- [ ] –°–æ–∑–¥–∞—Ç—å BaseModelHandler —Å –º–µ—Ç–æ–¥–∞–º–∏:
  - validate_input()
  - format_payload()
  - handle_callback()
- [ ] –ù–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å ZImageHandler –æ—Ç BaseModelHandler
- [ ] –î–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏ –¢–û–õ–¨–ö–û mapping inputs
- [ ] –ù–ï —Ç—Ä–æ–≥–∞—Ç—å job lifecycle/locking/callback pipeline

## üîß –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
- `app/services/kie_image_service.py` - API client
- `bot/handlers/models.py` - UI –∫–Ω–æ–ø–∫–∏
- `bot/handlers/generate.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–º–ø—Ç–∞

### Callback
- `app/api/routes.py` - /callbacks/kie endpoint
- `app/utils/orphan_reconciler.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö
- `app/database/services.py` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### Persistence
- `app/storage/migrations/` - –≤—Å–µ SQL —Ñ–∞–π–ª—ã
- `app/database/models.py` - —Ç–∞–±–ª–∏—Ü—ã users, generation_jobs
- `app/storage/factory.py` - ensure_user

## üö® –ö—Ä–∞—Å–Ω—ã–µ –ª–∏–Ω–∏–∏
- –ù–ï —É–¥–∞–ª—è—Ç—å –∫–æ–¥ –¥—Ä—É–≥–∏—Ö –º–æ–¥–µ–ª–µ–π
- –ù–ï –º–µ–Ω—è—Ç—å —è–¥—Ä–æ job lifecycle
- –ù–ï –ª–æ–º–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ ALTER)
- –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –±–µ–∑ –∫—Ä–∞–π–Ω–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## ‚úÖ Definition of Done
1. /start –æ—Ç–≤–µ—á–∞–µ—Ç
2. z-image –∫–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è z-image: 20/20 —É—Å–ø–µ—à–Ω–æ
4. 0 –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö callbacks
5. 0 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å–ø–∏—Å–∞–Ω–∏–π
6. 0 –æ—à–∏–±–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π
