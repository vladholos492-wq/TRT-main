# ИСПРАВЛЕНИЕ ТАЙМАУТА ПРИ ИМПОРТЕ

## Проблема
Бот падает с SIGTERM при импорте bot_kie на Render. Это происходит из-за блокирующих операций при импорте модуля.

## Исправления

### 1. Убрана проверка версии Tesseract при импорте
- **Было:** `pytesseract.get_tesseract_version()` вызывалась при импорте
- **Стало:** Проверка отложена до момента использования OCR
- **Файл:** `bot_kie.py`, строки 88-91

### 2. Ленивая инициализация KnowledgeStorage
- **Было:** `storage = KnowledgeStorage()` создавала директорию при импорте
- **Стало:** Инициализация отложена до вызова `main()`
- **Файл:** `bot_kie.py`, строки 115-116, 6034-6035
- **Файл:** `knowledge_storage.py` - добавлен флаг `_initialized`

### 3. Ленивая инициализация KIE клиента
- **Было:** `kie = get_client()` при импорте
- **Стало:** Инициализация отложена до вызова `main()`
- **Файл:** `bot_kie.py`, строки 115-116, 6034-6036

### 4. Безопасная обработка ADMIN_ID
- **Было:** `int(os.getenv('ADMIN_ID', '6913446846'))` могла упасть при невалидном значении
- **Стало:** Добавлена обработка ошибок с fallback
- **Файл:** `bot_kie.py`, строки 100-108

### 5. Инициализация в main()
Все тяжелые операции перенесены в функцию `main()`:
```python
def main():
    global storage, kie
    
    # Initialize storage and KIE client here (not at import time)
    if storage is None:
        storage = KnowledgeStorage()
    if kie is None:
        kie = get_client()
```

### 6. Проверки при использовании
Добавлены проверки и инициализация в местах использования:
- `start_generation()` - проверяет и инициализирует `kie` если нужно
- Все методы `KnowledgeStorage` вызывают `ensure_storage_exists()` при первом использовании

## Результат
- Импорт модуля стал быстрым (не блокирует)
- Все тяжелые операции выполняются только при запуске бота
- Нет блокирующих операций при импорте

## Тестирование
Локально импорт занимает ~0.8 секунды и проходит успешно.

