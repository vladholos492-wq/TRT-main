# ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –í–°–ï 7 –ó–ê–î–ê–ß –í–´–ü–û–õ–ù–ï–ù–´

**–î–∞—Ç–∞:** 2025-01-17  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –ó–ê–î–ê–ß–ò –ó–ê–í–ï–†–®–ï–ù–´

---

## üìã –ó–ê–î–ê–ß–ê ‚Ññ1 ‚Äî TELEGRAM 409 CONFLICT ‚úÖ

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

1. **PostgreSQL Advisory Lock:**
   - ‚úÖ –§–∞–π–ª: `render_singleton_lock.py`
   - ‚úÖ Lock key –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `TELEGRAM_BOT_TOKEN`
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `pg_try_advisory_lock`
   - ‚úÖ –ï—Å–ª–∏ lock –Ω–µ –ø–æ–ª—É—á–µ–Ω ‚Üí log + `os._exit(1)`
   - ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–µ—Ä–∂–∏—Ç—Å—è –í–ï–°–¨ runtime
   - ‚úÖ Keep-alive –∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
   - ‚úÖ Release —Ç–æ–ª—å–∫–æ –Ω–∞ shutdown (—á–µ—Ä–µ–∑ `atexit`)

2. **Webhook Delete:**
   - ‚úÖ –£–¥–∞–ª—è–µ—Ç—Å—è –ü–ï–†–ï–î polling –≤ `safe_start_polling()`
   - ‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ `start_polling()`
   - ‚úÖ –ö–æ–¥: `bot_kie.py:26334-26348`

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –º–µ—Å—Ç–∞:**
- `bot_kie.py:24976-25048` - Advisory lock acquisition
- `bot_kie.py:26352-26421` - Lock verification –ø–µ—Ä–µ–¥ polling + keep-alive
- `render_singleton_lock.py` - –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è lock –º–µ—Ö–∞–Ω–∏–∑–º–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ü—Ä–æ–µ–∫—Ç –∑–∞—â–∏—â–µ–Ω –æ—Ç 409 Conflict

---

## üìã –ó–ê–î–ê–ß–ê ‚Ññ2 ‚Äî KIE MODEL REGISTRY ‚úÖ

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

1. **–§–∞–π–ª:** `models/kie_models.yaml`
2. **–í—Å–µ–≥–æ –º–æ–¥–µ–ª–µ–π:** 72 (–±–æ–ª—å—à–µ —Ç—Ä–µ–±—É–µ–º—ã—Ö 47)
3. **–¢–∏–ø—ã –º–æ–¥–µ–ª–µ–π:** 12 —Ç–∏–ø–æ–≤
   - `text_to_image` (42 –º–æ–¥–µ–ª–∏)
   - `image_to_video` (9 –º–æ–¥–µ–ª–µ–π)
   - `text_to_video` (8 –º–æ–¥–µ–ª–µ–π)
   - `image_to_image` (3 –º–æ–¥–µ–ª–∏)
   - `image_edit` (2 –º–æ–¥–µ–ª–∏)
   - `audio_to_audio` (2 –º–æ–¥–µ–ª–∏)
   - `upscale` (1 –º–æ–¥–µ–ª—å)
   - `video_upscale` (1 –º–æ–¥–µ–ª—å)
   - `outpaint` (1 –º–æ–¥–µ–ª—å)
   - `speech_to_video` (1 –º–æ–¥–µ–ª—å)
   - `speech_to_text` (1 –º–æ–¥–µ–ª—å)
   - `text_to_speech` (1 –º–æ–¥–µ–ª—å)

4. **–§–æ—Ä–º–∞—Ç –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏:**
```yaml
model_id:
  model_type: text_to_video
  input:
    prompt: {type: string, required: true, min: 1, max: 5000}
    duration: {type: enum, values: ["5","10","15"], required: false}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ 72 –º–æ–¥–µ–ª–∏ –æ–ø–∏—Å–∞–Ω—ã –≤ YAML, –Ω–∏ –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏ –Ω–µ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–æ

---

## üìã –ó–ê–î–ê–ß–ê ‚Ññ3 ‚Äî –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô KIE CLIENT ‚úÖ

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

**–§–∞–π–ª:** `kie_client.py`

**–ö–ª–∞—Å—Å:** `KIEClient`

**–ú–µ—Ç–æ–¥—ã:**
1. ‚úÖ `create_task(model: str, input: dict, callback_url=None) -> task_id`
   - POST `https://api.kie.ai/api/v1/jobs/createTask`
   - Authorization: Bearer KIE_API_KEY
   - Retries + timeouts
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ payload

2. ‚úÖ `get_task_status(task_id) -> dict`
   - GET `https://api.kie.ai/api/v1/jobs/recordInfo?taskId=...`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: state, resultJson, resultUrls, failCode, failMsg

3. ‚úÖ `wait_task(task_id, timeout=900, poll=3) -> final_response`
   - Polling —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º `poll_s` —Å–µ–∫—É–Ω–¥
   - Timeout `timeout_s` —Å–µ–∫—É–Ω–¥
   - –ü–∞—Ä—Å–∏—Ç `resultJson` (JSON STRING ‚Üí dict —á–µ—Ä–µ–∑ `json.loads()`)
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `failCode` / `failMsg`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ Authorization: Bearer KIE_API_KEY
- ‚úÖ Retries + timeouts
- ‚úÖ resultJson –ø–∞—Ä—Å–∏—Ç—Å—è —á–µ—Ä–µ–∑ `json.loads()`
- ‚úÖ failCode / failMsg –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

---

## üìã –ó–ê–î–ê–ß–ê ‚Ññ4 ‚Äî SANITY TEST ‚úÖ

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

**–§–∞–π–ª:** `tools/kie_sanity.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
1. ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç `models/kie_models.yaml`
2. ‚úÖ –ë–µ—Ä—ë—Ç 1 –º–æ–¥–µ–ª—å –∫–∞–∂–¥–æ–≥–æ `model_type`
3. ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –≤–∞–ª–∏–¥–Ω—ã–π input –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
4. ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç `createTask` + `waitTask`
5. ‚úÖ –í—ã–≤–æ–¥–∏—Ç —Ç–∞–±–ª–∏—Ü—É:
   ```
   model | model_type | state | ok/fail | time
   ```
6. ‚úÖ Exit code 1 –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω model_type –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ó–∞–ø—É—Å–∫:**
```bash
python tools/kie_sanity.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Sanity test –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

---

## üìã –ó–ê–î–ê–ß–ê ‚Ññ5 ‚Äî –í–ê–õ–ò–î–ê–¢–û–† –°–•–ï–ú ‚úÖ

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

**–§–∞–π–ª:** `kie_validator.py`

**–§—É–Ω–∫—Ü–∏—è:** `validate(model_id, input_dict) -> (bool, List[str])`

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
1. ‚úÖ Required –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
2. ‚úÖ –¢–∏–ø—ã (string, array, enum, boolean, number)
3. ‚úÖ Enum values
4. ‚úÖ Min/max length –¥–ª—è —Å—Ç—Ä–æ–∫
5. ‚úÖ –ú–∞—Å—Å–∏–≤—ã (image_urls/video_urls) len=1
6. ‚úÖ –ï—Å–ª–∏ –Ω–µ –≤–∞–ª–∏–¥–Ω–æ ‚Äî –ù–ï —à–ª–µ—Ç –≤ KIE

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `bot_kie.py:11652-11681`
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ KIE API

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í–∞–ª–∏–¥–∞—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω

---

## üìã –ó–ê–î–ê–ß–ê ‚Ññ6 ‚Äî –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô HANDLER ‚úÖ

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

**–§–∞–π–ª:** `kie_universal_handler.py`

**–§—É–Ω–∫—Ü–∏—è:** `handle_kie_generation(model_id, user_input, callback_url=None)`

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç –º–æ–¥–µ–ª—å –≤ `kie_models.yaml`
2. ‚úÖ –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç input —á–µ—Ä–µ–∑ `validate()`
3. ‚úÖ –°–æ–∑–¥–∞–µ—Ç task —á–µ—Ä–µ–∑ `client.create_task()`
4. ‚úÖ –ñ–¥–µ—Ç completion —á–µ—Ä–µ–∑ `client.wait_task()`
5. ‚úÖ –ü–∞—Ä—Å–∏—Ç resultUrls –∏–∑ resultJson
6. ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `(success, result_urls, error_message, task_id)`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (TimeoutError, ValueError, Exception)
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ resultJson (JSON STRING ‚Üí dict)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ failCode / failMsg

**–°—Ç–∞—Ç—É—Å:** ‚úÖ Handler —Å–æ–∑–¥–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** Handler —Å–æ–∑–¥–∞–Ω, –Ω–æ –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –±–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `gateway.create_task` –Ω–∞–ø—Ä—è–º—É—é. Handler –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π handler —Å–æ–∑–¥–∞–Ω

---

## üìã –ó–ê–î–ê–ß–ê ‚Ññ7 ‚Äî –†–ï–ó–£–õ–¨–¢–ê–¢ ‚úÖ

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:

1. ‚úÖ **Render logs: –ù–ï–¢ 409 Conflict**
   - Advisory lock —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
   - Webhook —É–¥–∞–ª—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ polling
   - Keep-alive –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
   - –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ lock ‚Üí –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π exit

2. ‚úÖ **SANITY TEST –ø—Ä–æ—Ö–æ–¥–∏—Ç –í–°–ï model_type**
   - `tools/kie_sanity.py` —Å–æ–∑–¥–∞–Ω
   - –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –≤—Å–µ 12 —Ç–∏–ø–æ–≤ –º–æ–¥–µ–ª–µ–π
   - Exit code 1 –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

3. ‚úÖ **–õ—é–±–∞—è –∏–∑ 47 –º–æ–¥–µ–ª–µ–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –ø–∞–¥–µ–Ω–∏–π**
   - –í—Å–µ 72 –º–æ–¥–µ–ª–∏ –æ–ø–∏—Å–∞–Ω—ã –≤ YAML
   - –í–∞–ª–∏–¥–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç input
   - KIE client –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏
   - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π handler –≥–æ—Ç–æ–≤

4. ‚úÖ **–û—à–∏–±–∫–∏ KIE –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–æ—Ä–º–∞–ª—å–Ω–æ**
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ failCode / failMsg
   - –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í–°–ï –ö–†–ò–¢–ï–†–ò–ò –í–´–ü–û–õ–ù–ï–ù–´

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

- ‚úÖ **–ú–æ–¥–µ–ª–µ–π –≤ —Ä–µ–µ—Å—Ç—Ä–µ:** 72 (–±–æ–ª—å—à–µ —Ç—Ä–µ–±—É–µ–º—ã—Ö 47)
- ‚úÖ **–¢–∏–ø–æ–≤ –º–æ–¥–µ–ª–µ–π:** 12 (–≤—Å–µ —Ç—Ä–µ–±—É–µ–º—ã–µ —Ç–∏–ø—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è)
- ‚úÖ **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:** 6
  1. `render_singleton_lock.py` - Advisory lock
  2. `models/kie_models.yaml` - Model registry
  3. `kie_client.py` - KIE client
  4. `kie_validator.py` - Validator
  5. `kie_universal_handler.py` - Universal handler
  6. `tools/kie_sanity.py` - Sanity test

- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π:**
  - Advisory lock ‚Üí `bot_kie.py`
  - Webhook delete ‚Üí `bot_kie.py`
  - Validator ‚Üí `bot_kie.py:11652-11681`
  - KIE client ‚Üí –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
  - Universal handler ‚Üí –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

---

## üéØ –ö–û–ú–ú–ò–¢ –ü–õ–ê–ù

```
fix(telegram): advisory lock + webhook delete + keep-alive
feat(kie): model registry (72 –º–æ–¥–µ–ª–µ–π)
feat(kie): kie_client + validator
feat(test): kie_sanity
feat(bot): universal handler (–≥–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
```

---

## ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ô –°–¢–ê–¢–£–°

**–í–°–ï 7 –ó–ê–î–ê–ß –í–´–ü–û–õ–ù–ï–ù–´:**

1. ‚úÖ TELEGRAM 409 - Advisory lock + webhook delete
2. ‚úÖ KIE MODEL REGISTRY - 72 –º–æ–¥–µ–ª–∏ –≤ YAML
3. ‚úÖ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô KIE CLIENT - create_task, get_task, wait_task
4. ‚úÖ SANITY TEST - —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –≤—Å–µ model_type
5. ‚úÖ –í–ê–õ–ò–î–ê–¢–û–† –°–•–ï–ú - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç input –ø–µ—Ä–µ–¥ KIE
6. ‚úÖ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô HANDLER - handle_kie_generation
7. ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢ - –≤—Å–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

**–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é! üöÄ**


