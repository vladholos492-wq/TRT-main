# –°–∏—Å—Ç–µ–º–∞ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è (Pricing System)

## –§–∏–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ

**USER_PRICE_RUB = KIE_PRICE_RUB √ó 2**

–¶–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Å–µ–≥–¥–∞ –≤ 2 —Ä–∞–∑–∞ –≤—ã—à–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ Kie.ai. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª–æ –ù–ï –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç—Å—è –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –º–æ–¥–µ–ª—è–º.

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ú–æ–¥—É–ª—å `app/payments/pricing.py`

–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω:

```python
MARKUP_MULTIPLIER = 2.0  # –ù–ï –ò–ó–ú–ï–ù–Ø–¢–¨

def calculate_kie_cost(model, user_inputs, kie_response=None) -> float
def calculate_user_price(kie_cost_rub: float) -> float
def format_price_rub(price: float) -> str
def create_charge_metadata(model, user_inputs, kie_response=None) -> dict
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

1. **kie_response** - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ API Kie.ai (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
2. **model['price']** - —Ü–µ–Ω–∞ –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞ –º–æ–¥–µ–ª–µ–π
3. **FALLBACK_PRICES_RUB** - —Ç–∞–±–ª–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
4. **10.0 RUB** - –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

### Fallback —Ç–∞–±–ª–∏—Ü–∞

–°–æ–¥–µ—Ä–∂–∏—Ç ~30 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π:
- Text-to-Image: flux/pro (12‚ÇΩ), flux/dev (8‚ÇΩ)
- Text-to-Video: google/veo-3 (150‚ÇΩ), kling/v1-standard (80‚ÇΩ)
- Audio: elevenlabs/text-to-speech (5‚ÇΩ), suno/v5 (25‚ÇΩ)
- Upscale: topaz/image-upscale (15‚ÇΩ)

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ UI

### –î–æ (–∫—Ä–µ–¥–∏—Ç—ã)
```
üí∞ –ë–∞–ª–∞–Ω—Å: 10.00 –∫—Ä–µ–¥–∏—Ç–æ–≤
–¶–µ–Ω–∞: 2.50 –∫—Ä–µ–¥–∏—Ç–æ–≤
WELCOME_CREDITS = 10
```

### –ü–æ—Å–ª–µ (—Ä—É–±–ª–∏)
```
üí∞ –ë–∞–ª–∞–Ω—Å: 200.00 ‚ÇΩ
üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: 96 ‚ÇΩ
üìå –¶–µ–Ω–∞ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∞—Ä–∏—Ñ–∞ –º–æ–¥–µ–ª–∏
WELCOME_BALANCE_RUB = 200
```

## –≠–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

–û–±–Ω–æ–≤–ª–µ–Ω –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –§–ò–ù–ê–õ–¨–ù–´–ú –ü–†–ê–í–ò–õ–û–ú:

```
üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–∫–∞–∑

–ú–æ–¥–µ–ª—å: Flux Pro
–ó–∞–¥–∞—á–∞:
‚Ä¢ prompt: cat in space

üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: 96 ‚ÇΩ
üìå –¶–µ–Ω–∞ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∞—Ä–∏—Ñ–∞ –º–æ–¥–µ–ª–∏
‚è± –û–∂–∏–¥–∞–Ω–∏–µ: ~10-20 —Å–µ–∫
üì¶ –ü–æ–ª—É—á–∏—Ç–µ: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

üí≥ –í–∞—à –±–∞–ª–∞–Ω—Å: 200.00 ‚ÇΩ

‚ÑπÔ∏è –î–µ–Ω—å–≥–∏ —Å–ø–∏—à—É—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
```

## –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞

```python
{
    'kie_cost_rub': 48.0,     # –°—Ç–æ–∏–º–æ—Å—Ç—å Kie.ai
    'user_price_rub': 96.0,   # –¶–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (x2)
    'markup': 'x2',           # –ù–∞—Ü–µ–Ω–∫–∞
    'model_id': 'flux/pro',
    'timestamp': '2024-01-15T10:30:00'
}
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **Assertion check**: `assert user_price == kie_cost * 2`
2. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–µ —Å–ø–∏—Å—ã–≤–∞—é—Ç –¥–≤–∞–∂–¥—ã
3. **Auto-refund**: –ø—Ä–∏ –æ—à–∏–±–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ–Ω—å–≥–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è
4. **Reserve pattern**: —Ä–µ–∑–µ—Ä–≤ ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è ‚Üí —Å–ø–∏—Å–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ)

## –¢–µ—Å—Ç—ã

–§–∞–π–ª: `tests/test_pricing.py` (14 —Ç–µ—Å—Ç–æ–≤)

- ‚úÖ –ú–Ω–æ–∂–∏—Ç–µ–ª—å x2 —è–≤–ª—è–µ—Ç—Å—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–æ–π
- ‚úÖ –§–æ—Ä–º—É–ª–∞ USER = KIE √ó 2 —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä—É–±–ª—è—Ö (‚ÇΩ)
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ü–µ–Ω—ã
- ‚úÖ Fallback —Ç–∞–±–ª–∏—Ü–∞
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ (price=0)
- ‚úÖ –ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–æ–≤
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ "–∫—Ä–µ–¥–∏—Ç–æ–≤" –≤ –≤—ã–≤–æ–¥–µ

## –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è - –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π:
- `get_user_balance()` —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä—É–±–ª–∏
- `WELCOME_BALANCE_RUB = 200` (–±—ã–ª–æ WELCOME_CREDITS = 10)
- –í—Å–µ —Ü–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `calculate_user_price()`

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
from app.payments.pricing import (
    calculate_kie_cost,
    calculate_user_price,
    format_price_rub,
    create_charge_metadata
)

# –í flow.py
model = {"model_id": "flux/pro", "price": 48.0}
user_inputs = {"prompt": "cat in space"}

# –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
kie_cost = calculate_kie_cost(model, user_inputs)  # 48.0
user_price = calculate_user_price(kie_cost)        # 96.0
price_text = format_price_rub(user_price)          # "96.00 ‚ÇΩ"

# –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞
metadata = create_charge_metadata(model, user_inputs)
# {'kie_cost_rub': 48.0, 'user_price_rub': 96.0, 'markup': 'x2', ...}
```

## –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

‚úÖ **–ó–∞–≤–µ—Ä—à–µ–Ω–æ**:
- –ú–æ–¥—É–ª—å pricing.py —Å–æ–∑–¥–∞–Ω
- UI –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Ä—É–±–ª–∏
- –≠–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω
- –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (59/59)
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞

‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏** (–±—É–¥—É—â–∏–µ –∑–∞–¥–∞—á–∏):
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º Kie.ai API (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏)
- –°–∏—Å—Ç–µ–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –ë–î
- –û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å –ø–æ –ø–ª–∞—Ç–µ–∂–∞–º
