"""
–ú–æ–¥—É–ª—å –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API.
–í–∫–ª—é—á–∞–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤.
"""

import logging
import asyncio
from typing import Dict, Any, Optional, Set
from collections import defaultdict
import time

logger = logging.getLogger(__name__)

# –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
_active_requests: Dict[str, asyncio.Task] = {}
_request_lock = asyncio.Lock()


async def deduplicate_api_request(
    request_key: str,
    request_func,
    timeout: float = 30.0
) -> Any:
    """
    –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤.
    
    Args:
        request_key: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –∑–∞–ø—Ä–æ—Å–∞
        request_func: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
        timeout: –¢–∞–π–º–∞—É—Ç –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    
    Returns:
        –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
    """
    async with _request_lock:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ç–∞–∫–∏–º –∫–ª—é—á–æ–º
        if request_key in _active_requests:
            existing_task = _active_requests[request_key]
            
            # –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –∂–¥–µ–º –µ—ë —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if not existing_task.done():
                logger.debug(f"üîÑ –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: {request_key}")
                try:
                    result = await asyncio.wait_for(existing_task, timeout=timeout)
                    return result
                except asyncio.TimeoutError:
                    logger.warning(f"‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ {request_key}")
                    # –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö
                    del _active_requests[request_key]
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ {request_key}: {e}")
                    del _active_requests[request_key]
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
        task = asyncio.create_task(request_func())
        _active_requests[request_key] = task
        
        try:
            result = await task
            return result
        finally:
            # –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            if request_key in _active_requests:
                del _active_requests[request_key]


def create_request_key(operation: str, **kwargs) -> str:
    """
    –°–æ–∑–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞.
    
    Args:
        operation: –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏
        **kwargs: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
    
    Returns:
        –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
    """
    import hashlib
    import json
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    sorted_params = json.dumps(kwargs, sort_keys=True)
    key_input = f"{operation}:{sorted_params}"
    return hashlib.md5(key_input.encode()).hexdigest()


async def cached_api_request(
    cache_key: str,
    request_func,
    cache_ttl: float = 300.0,
    use_cache: bool = True
) -> Any:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç API –∑–∞–ø—Ä–æ—Å —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
    
    Args:
        cache_key: –ö–ª—é—á –∫–µ—à–∞
        request_func: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
        cache_ttl: –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–µ—à–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        use_cache: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ –∫–µ—à
    
    Returns:
        –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
    """
    try:
        from optimization_cache import get_cached_request, set_cached_request
        
        if use_cache:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
            cached = get_cached_request(cache_key)
            if cached is not None:
                logger.debug(f"‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫–µ—à –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: {cache_key[:16]}...")
                return cached
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
        result = await request_func()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
        if use_cache and result:
            set_cached_request(cache_key, result, cache_ttl)
        
        return result
        
    except ImportError:
        # –ï—Å–ª–∏ –∫–µ—à –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
        return await request_func()
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ: {e}", exc_info=True)
        return await request_func()


def validate_api_params_before_request(model_id: str, params: Dict[str, Any]) -> tuple[bool, Optional[str]]:
    """
    –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞ –∫ API.
    
    Args:
        model_id: ID –º–æ–¥–µ–ª–∏
        params: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
    
    Returns:
        (–≤–∞–ª–∏–¥–Ω–æ, —Å–æ–æ–±—â–µ–Ω–∏–µ_–æ–±_–æ—à–∏–±–∫–µ)
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    if not model_id:
        return False, "Model ID –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π
    if 'prompt' not in params and 'text' not in params:
        # –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–æ–¥–µ–ª–µ–π –ø—Ä–æ–º–ø—Ç –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
        if 'image' not in params and 'video' not in params:
            return False, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø—Ä–æ–º–ø—Ç, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≤–∏–¥–µ–æ"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –ø—Ä–æ–º–ø—Ç–∞
    prompt = params.get('prompt') or params.get('text', '')
    if prompt and len(prompt) > 5000:
        return False, "–ü—Ä–æ–º–ø—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–º–∞–∫—Å–∏–º—É–º 5000 —Å–∏–º–≤–æ–ª–æ–≤)"
    
    return True, None

