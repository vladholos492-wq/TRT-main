# Changelog: Pricing System Implementation (x2 RUB Markup)

## –î–∞—Ç–∞: 2024-01-15

### ‚ú® –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

1. **`app/payments/pricing.py`** (163 —Å—Ç—Ä–æ–∫–∏)
   - –ú–æ–¥—É–ª—å —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω —Å —Ñ–æ—Ä–º—É–ª–æ–π USER_PRICE_RUB = KIE_PRICE_RUB √ó 2
   - `MARKUP_MULTIPLIER = 2.0` - –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –Ω–∞—Ü–µ–Ω–∫–∏
   - `FALLBACK_PRICES_RUB` - —Ç–∞–±–ª–∏—Ü–∞ —Ü–µ–Ω ~30 –º–æ–¥–µ–ª–µ–π
   - –§—É–Ω–∫—Ü–∏–∏: `calculate_kie_cost()`, `calculate_user_price()`, `format_price_rub()`, `create_charge_metadata()`

2. **`tests/test_pricing.py`** (14 —Ç–µ—Å—Ç–æ–≤)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º—É–ª—ã x2
   - –¢–µ—Å—Ç—ã –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ü–µ–Ω—ã
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä—É–±–ª—è—Ö
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞

3. **`docs/pricing_system.md`**
   - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### üîß –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

#### `bot/handlers/flow.py`
- **–ò–º–ø–æ—Ä—Ç—ã**: –¥–æ–±–∞–≤–ª–µ–Ω—ã `calculate_user_price, format_price_rub` –∏–∑ pricing
- **WELCOME_CREDITS ‚Üí WELCOME_BALANCE_RUB**: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ (10 ‚Üí 200)
- **–ö–∞—Ä—Ç–æ—á–∫–∞ –º–æ–¥–µ–ª–∏** (—Å—Ç—Ä–æ–∫–∏ 166-175): —Ü–µ–Ω–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ —Ä—É–±–ª—è—Ö —Å x2 –Ω–∞—Ü–µ–Ω–∫–æ–π
- **–ë–∞–ª–∞–Ω—Å** (—Å—Ç—Ä–æ–∫–∞ 522): —Ñ–æ—Ä–º–∞—Ç `{format_price_rub(balance)}` –≤–º–µ—Å—Ç–æ `{balance:.2f} –∫—Ä–µ–¥–∏—Ç–æ–≤`
- **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ —Å—Ä–µ–¥—Å—Ç–≤** (—Å—Ç—Ä–æ–∫–∏ 606-608): "–°—Ç–æ–∏–º–æ—Å—Ç—å: X ‚ÇΩ" –≤–º–µ—Å—Ç–æ "–¶–µ–Ω–∞: X"
- **–≠–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è** (—Å—Ç—Ä–æ–∫–∏ 855-915):
  - –†–∞—Å—á–µ—Ç —á–µ—Ä–µ–∑ `calculate_user_price(kie_cost_estimate)`
  - –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç: "üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: 96 ‚ÇΩ"
  - –î–æ–±–∞–≤–ª–µ–Ω–æ: "üìå –¶–µ–Ω–∞ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∞—Ä–∏—Ñ–∞ –º–æ–¥–µ–ª–∏"
  - –û–±–Ω–æ–≤–ª–µ–Ω–æ: "‚ÑπÔ∏è –î–µ–Ω—å–≥–∏ —Å–ø–∏—à—É—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"
  - –ë–∞–ª–∞–Ω—Å: `{format_price_rub(balance)}`

#### `app/payments/charges.py`
- **create_pending_charge()** (—Å—Ç—Ä–æ–∫–∞ 52+): –¥–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ pricing metadata
- –õ–æ–≥–∏ —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞—é—Ç `kie_cost_rub` –∏–∑ metadata

#### `tests/test_flow_smoke.py`
- **test_confirm_insufficient_balance**: –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —É—á–µ—Ç–∞ WELCOME_BALANCE_RUB
  - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ 100 RUB
  - –¶–µ–Ω–∞ –º–æ–¥–µ–ª–∏ 150 ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç 300 (x2)
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"

### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
pytest tests/ -v
59 passed in 8.30s

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
compileall -q .
‚úÖ Compilation OK

# –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
python scripts/verify_project.py
[OK] All invariants satisfied!
```

### üéØ –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

| –î–æ | –ü–æ—Å–ª–µ |
|----|-------|
| `WELCOME_CREDITS = 10` | `WELCOME_BALANCE_RUB = 200` |
| "10.00 –∫—Ä–µ–¥–∏—Ç–æ–≤" | "200.00 ‚ÇΩ" |
| "–¶–µ–Ω–∞: 2.50 –∫—Ä–µ–¥–∏—Ç–æ–≤" | "üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: 96 ‚ÇΩ" |
| –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º—É–ª—ã | `assert user_price == kie_cost * 2` |
| –ù–µ—Ç fallback —Ü–µ–Ω | FALLBACK_PRICES_RUB —Ç–∞–±–ª–∏—Ü–∞ |

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏

1. **–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ x2**: `MARKUP_MULTIPLIER = 2.0` (–Ω–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç—Å—è)
2. **Assertion check**: –∫–∞–∂–¥—ã–π —Ä–∞—Å—á–µ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ñ–æ—Ä–º—É–ª–æ–π
3. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤**: API response > registry > fallback > default
4. **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ**: –∫–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ö—Ä–∞–Ω–∏—Ç `kie_cost_rub` –∏ `user_price_rub`
5. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ charges.py

### üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥

- ‚ö†Ô∏è –†–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Kie.ai API (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏–∑ response)
- ‚ö†Ô∏è –•—Ä–∞–Ω–µ–Ω–∏–µ pricing metadata –≤ –ë–î
- ‚ö†Ô∏è –°–∏—Å—Ç–µ–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- ‚ö†Ô∏è –û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º

### ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±–∞–ª–∞–Ω—Å–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç (—Ç–µ–ø–µ—Ä—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ RUB)
- ‚úÖ API charges.py –Ω–µ –∏–∑–º–µ–Ω–µ–Ω (—Ç–æ–ª—å–∫–æ metadata —Ä–∞—Å—à–∏—Ä–µ–Ω)
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –ø—Ä–æ—Ö–æ–¥—è—Ç

### üöÄ –î–µ–ø–ª–æ–π

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –¥–µ–ø–ª–æ—é –Ω–∞ Render:
```bash
git add app/payments/pricing.py tests/test_pricing.py bot/handlers/flow.py
git commit -m "feat: implement x2 RUB pricing system"
git push origin main
```

---

**–ê–≤—Ç–æ—Ä**: GitHub Copilot  
**–ú–æ–¥–µ–ª—å**: Claude Sonnet 4.5  
**–¢–µ—Å—Ç—ã**: 59/59 ‚úÖ  
**–ö–æ–º–ø–∏–ª—è—Ü–∏—è**: OK ‚úÖ  
**–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è**: OK ‚úÖ
