name: Deploy to Render

on:
  workflow_run:
    workflows: ["CI - Verify & Behavioral E2E"]
    types:
      - completed
    branches: [main, master]
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || startsWith(github.ref, 'refs/tags/v') }}
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy via Render Deploy Hook (preferred)
        if: env.RENDER_DEPLOY_HOOK != ''
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          echo "ðŸš€ Deploying via Render Deploy Hook..."
          response=$(curl -X POST "$RENDER_DEPLOY_HOOK" -w "\n%{http_code}" -s)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "âœ… Deploy triggered successfully"
            echo "Response: $body"
          else
            echo "âŒ Deploy failed with HTTP $http_code"
            echo "Response: $body"
            exit 1
          fi
      
      - name: Deploy via Render API (fallback)
        if: env.RENDER_DEPLOY_HOOK == '' && env.RENDER_API_KEY != '' && env.RENDER_SERVICE_ID != ''
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "ðŸš€ Deploying via Render API..."
          response=$(curl -X POST \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Accept: application/json" \
            -w "\n%{http_code}" \
            -s)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "âœ… Deploy triggered successfully"
            echo "Response: $body"
          else
            echo "âŒ Deploy failed with HTTP $http_code"
            echo "Response: $body"
            exit 1
          fi
      
      - name: Wait for deploy
        run: |
          echo "â³ Waiting 30 seconds for deploy to start..."
          sleep 30
      
      - name: Health check
        if: env.RENDER_HEALTH_URL != ''
        env:
          RENDER_HEALTH_URL: ${{ secrets.RENDER_HEALTH_URL }}
        run: |
          echo "ðŸ¥ Checking health endpoint..."
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts..."
            if curl -f -s "$RENDER_HEALTH_URL/health" > /dev/null 2>&1 || \
               curl -f -s "$RENDER_HEALTH_URL/healthz" > /dev/null 2>&1 || \
               curl -f -s "$RENDER_HEALTH_URL/" > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "â³ Waiting 15 seconds before next attempt..."
            sleep 15
            attempt=$((attempt + 1))
          done
          
          echo "âŒ Health check failed after $max_attempts attempts"
          exit 1
      
      - name: Generate Deploy Summary
        if: always()
        run: |
          echo "## Deploy Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Status:** Deploy successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Deploy failed" >> $GITHUB_STEP_SUMMARY
          fi
