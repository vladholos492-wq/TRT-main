# Deploy Checklist: Как избежать очереди из 3 деплоев

## Правило: ОДИН цикл = ОДИН коммит = ОДИН пуш

### Перед КАЖДЫМ коммитом/пушем:

1. **Локальные проверки (ОБЯЗАТЕЛЬНО):**
   ```bash
   # 1. Синтаксис критичных файлов
   python -m py_compile main_render.py
   python -m py_compile app/utils/runtime_state.py
   python -m py_compile app/admin/db_diagnostics.py
   
   # 2. Синтаксис всех handlers
   python -m py_compile bot/handlers/*.py
   
   # 3. Enhanced pre-deploy verify (железный гейт)
   make pre-deploy-verify
   
   # 4. Или напрямую:
   python scripts/enhanced_pre_deploy_verify.py
   ```

2. **Если ЛЮБАЯ проверка FAIL - НЕ КОММИТЬ:**
   - Исправь ошибки локально
   - Повтори проверки
   - Только после всех PASS - коммить

3. **Один коммит на цикл:**
   - Если нужно несколько правок - делай их локально
   - Используй `git commit --amend` для объединения
   - В `origin/main` должна уйти ОДНА голова

4. **После пуша:**
   - НЕ анализировать Render logs в этом же цикле
   - Дождаться следующего цикла для проверки логов
   - Если есть ошибки - исправить в следующем цикле

### Типичные ошибки, которые создают очередь деплоев:

❌ **НЕ ДЕЛАТЬ:**
- Пуш с SyntaxError (создаёт 1-й деплой с ошибкой)
- Пуш с ImportError (создаёт 2-й деплой с ошибкой)
- Пуш без проверок (создаёт 3-й деплой с ошибкой)

✅ **ДЕЛАТЬ:**
- Все проверки локально ДО коммита
- Один коммит = все связанные правки
- Один пуш = один деплой

### Критерии "готово к пушу":

- [ ] `python -m py_compile main_render.py` = PASS
- [ ] `python -m py_compile bot/handlers/*.py` = PASS (все файлы)
- [ ] `make pre-deploy-verify` = PASS
- [ ] `TRT_REPORT.md` обновлён
- [ ] Все изменения в одном коммите
- [ ] Коммит сообщение понятное (P0/P1/UX/OPS prefix)

### Если проверки падают:

1. **SyntaxError/IndentationError:**
   - Исправить отступы/синтаксис
   - Повторить `py_compile`

2. **ImportError:**
   - Проверить циклические импорты
   - Проверить TYPE_CHECKING guards
   - Проверить `from __future__ import annotations`

3. **Unclosed try blocks:**
   - Найти незакрытые `try:` без `except`/`finally`
   - Исправить структуру

4. **smoke_import_check fails:**
   - Если это Windows dev env без aiogram - можно пропустить
   - Если это реальная ошибка - исправить импорты

### После успешного пуша:

- [ ] Дождаться деплоя Render (обычно 2-5 минут)
- [ ] В СЛЕДУЮЩЕМ цикле проверить логи через `make render:logs-10`
- [ ] Проверить /health endpoint
- [ ] Обновить TRT_REPORT.md с результатами

---

**Помни:** Один пуш = один деплой. Если нужно несколько правок - делай их локально, объединяй в один коммит, проверяй всё, потом один пуш.


