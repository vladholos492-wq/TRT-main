"""
Error mapper for KIE API responses.
Maps technical errors to user-friendly Russian messages.
"""
from typing import Dict, Tuple

def map_kie_error(error_code: any, error_message: str = "") -> Tuple[str, str]:
    """
    Map KIE error code to user-friendly message.
    
    Args:
        error_code: HTTP status code or error code string
        error_message: Raw error message from API
        
    Returns:
        Tuple of (emoji + title, detailed_message)
    """
    # Convert to int if possible
    try:
        status_code = int(error_code) if error_code else 0
    except (ValueError, TypeError):
        status_code = 0
    
    # Map status codes
    if status_code == 402:
        return (
            "ðŸ’³ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¾Ð² Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°",
            "ÐÐ° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ðµ Kie.ai Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¾Ð².\n"
            "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐÐ• Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°, ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° ÐÐ• ÑÐ¿Ð¸ÑÐ°Ð½Ñ‹.\n\n"
            "ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ Ð´Ð»Ñ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¾Ð² Kie.ai."
        )
    elif status_code == 401:
        return (
            "ðŸ”‘ ÐšÐ»ÑŽÑ‡ Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½",
            "API ÐºÐ»ÑŽÑ‡ Kie.ai Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½ Ð¸Ð»Ð¸ Ð¸ÑÑ‚Ñ‘Ðº.\n"
            "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐÐ• Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°, ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° ÐÐ• ÑÐ¿Ð¸ÑÐ°Ð½Ñ‹.\n\n"
            "ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ»ÑŽÑ‡Ð°."
        )
    elif status_code == 403:
        return (
            "â›” Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰Ñ‘Ð½",
            "ÐÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÑÑ‚Ð¾Ð¹ Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð½Ð° Kie.ai.\n"
            "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐÐ• Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°, ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° ÐÐ• ÑÐ¿Ð¸ÑÐ°Ð½Ñ‹.\n\n"
            "ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð´Ñ€ÑƒÐ³ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð¸Ð»Ð¸ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ."
        )
    elif status_code == 429:
        return (
            "â±ï¸ Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²",
            "ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº Kie.ai.\n"
            "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐÐ• Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°, ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° ÐÐ• ÑÐ¿Ð¸ÑÐ°Ð½Ñ‹.\n\n"
            "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼Ð¸Ð½ÑƒÑ‚ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
        )
    elif status_code >= 500:
        return (
            "ðŸ”§ ÐŸÑ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½",
            f"Ð¡ÐµÑ€Ð²ÐµÑ€ Kie.ai Ð²ÐµÑ€Ð½ÑƒÐ» Ð¾ÑˆÐ¸Ð±ÐºÑƒ {status_code}.\n"
            "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐÐ• Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°, ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° ÐÐ• ÑÐ¿Ð¸ÑÐ°Ð½Ñ‹.\n\n"
            "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ."
        )
    elif status_code >= 400:
        return (
            "âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°",
            f"ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ (ÐºÐ¾Ð´ {status_code}).\n"
            "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐÐ• Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°, ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° ÐÐ• ÑÐ¿Ð¸ÑÐ°Ð½Ñ‹.\n\n"
            "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
        )
    
    # Map error code strings
    error_code_str = str(error_code).upper() if error_code else ""
    
    if "INSUFFICIENT_CREDITS" in error_code_str:
        return (
            "ðŸ’³ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¾Ð² Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°",
            "ÐÐ° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ðµ Kie.ai Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¾Ð².\n"
            "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐÐ• Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°, ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° ÐÐ• ÑÐ¿Ð¸ÑÐ°Ð½Ñ‹."
        )
    elif "TIMEOUT" in error_code_str:
        return (
            "â±ï¸ ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ",
            "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð½ÑÐ»Ð° ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸.\n"
            "Ð¡Ñ€ÐµÐ´ÑÑ‚Ð²Ð° ÐÐ• ÑÐ¿Ð¸ÑÐ°Ð½Ñ‹ (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚).\n\n"
            "ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð° Ð¸Ð»Ð¸ Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´Ñ€ÑƒÐ³ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ."
        )
    elif "INVALID_INPUT" in error_code_str:
        return (
            "ðŸ“ ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ",
            "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð²Ð²ÐµÐ´Ñ‘Ð½Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.\n"
            "Ð¡Ñ€ÐµÐ´ÑÑ‚Ð²Ð° ÐÐ• ÑÐ¿Ð¸ÑÐ°Ð½Ñ‹."
        )
    elif "CONNECTION" in error_code_str or "NETWORK" in error_code_str:
        return (
            "ðŸŒ ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÐµÐ¼",
            "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Kie.ai.\n"
            "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐÐ• Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°, ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° ÐÐ• ÑÐ¿Ð¸ÑÐ°Ð½Ñ‹.\n\n"
            "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚-ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ."
        )
    
    # Generic error
    return (
        "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸",
        f"ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°: {error_message or 'Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°'}.\n"
        "Ð¡Ñ€ÐµÐ´ÑÑ‚Ð²Ð° ÐÐ• ÑÐ¿Ð¸ÑÐ°Ð½Ñ‹.\n\n"
        "ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð· Ð¸Ð»Ð¸ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ."
    )


def format_error_for_user(gen_result: Dict) -> str:
    """
    Format generation error result for user display.
    
    Args:
        gen_result: Generation result dict with error info
        
    Returns:
        Formatted user message
    """
    error_code = gen_result.get('error_code')
    error_message = gen_result.get('error_message', '')
    
    title, details = map_kie_error(error_code, error_message)
    
    return f"{title}\n\n{details}"
